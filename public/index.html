<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BUSMAP</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }
    
    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    
    .header {
      background-color: #0066cc;
      color: white;
      padding: 10px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    
    .header h1 {
      font-size: 1.5em;
      margin: 0;
      flex: 1;
      text-align: center;
    }
    
    .content {
      display: flex;
      flex: 1;
      position: relative;
    }
    
    .sidebar {
      width: 0;
      transition: width 0.3s;
      position: absolute;
      height: 100%;
      z-index: 1000;
      overflow: hidden;
    }
    
    .sidebar.open {
      width: 300px;
    }
    
    .sidebar-content {
      padding: 15px;
      background-color: #f5f5f5;
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
      display: none;
      height: 100%;
    }
    
    .sidebar.open .sidebar-content {
      display: block;
    }
    
    .menu-toggle {
      width: 50px;
      height: 50px;
      background-color: #0066cc;
      color: white;
      border: none;
      font-size: 24px;
      cursor: pointer;
      position: absolute;
      left: 10px;
    }
    
    .menu-toggle:hover {
      background-color: #0055aa;
    }
    
    #map {
      flex: 1;
      height: 100%;
    }
    
    .route-finder, .route-form, .nearest-stop {
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    select, input[type="text"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    button {
      background-color: #0066cc;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
    }
    
    button:hover {
      background-color: #0055aa;
    }
    
    .route-results {
      margin-top: 15px;
    }
    
    .route-result-item {
      padding: 10px;
      background-color: white;
      border-radius: 4px;
      margin-bottom: 10px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      cursor: pointer;
    }
    
    .route-result-item:hover {
      background-color: #f0f0f0;
    }
    
    .center-btn {
      margin-top: 10px;
      background-color: #28a745;
    }
    
    .center-btn:hover {
      background-color: #218838;
    }
    
    .error-message {
      color: red;
      padding: 10px;
      margin-bottom: 10px;
      background-color: #ffe6e6;
      border-radius: 4px;
    }
    
    .nearest-stop {
      margin-bottom: 20px;
    }
    
    #nearestStopInfo {
      margin-top: 10px;
      padding: 10px;
      background-color: white;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .toggle-markers {
      margin-top: 10px;
      background-color: #f39c12;
    }
    
    .toggle-markers:hover {
      background-color: #e67e22;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <button class="menu-toggle">☰</button>
      <h1>Busmap</h1>
    </div>
    
    <div class="content">
      <div class="sidebar">
        <div class="sidebar-content">
          <!-- Form chọn lộ trình -->
          <div class="route-form">
            <h3>Chọn lộ trình</h3>
            <div class="form-group">
              <label for="routeSelect">Tuyến xe buýt:</label>
              <select id="routeSelect">
                <option value="">-- Chọn tuyến --</option>
              </select>
            </div>
            <button id="showRouteBtn">Hiển thị lộ trình</button>
            <button id="centerMapBtn" class="center-btn">Về trung tâm bản đồ</button>
          </div>
          
          <!-- Tìm bến xe gần nhất -->
          <div class="nearest-stop">
            <h3>Tìm bến xe gần nhất</h3>
            <button id="findNearestStopBtn">Tìm bến gần nhất</button>
            <div id="nearestStopInfo"></div>
          </div>
        </div>
      </div>
      
      <div id="map"></div>
    </div>
  </div>
  
  <script>
    // Khởi tạo bản đồ
    const map = L.map('map', {
      zoomControl: false // Tắt điều khiển zoom mặc định để tùy chỉnh vị trí
    }).setView([21.027763, 105.83416], 13);
    const mapCenter = [21.027763, 105.83416];

    // Thêm điều khiển zoom ở góc trên bên phải
    L.control.zoom({
      position: 'topright'
    }).addTo(map);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Lưu trữ dữ liệu
    const markers = {};
    let currentRouteControl = null;
    let routeToNearestStopControl = null;
    let currentPosition = null;
    let nearestStopMarker = null;
    let currentPositionMarker = null;
    let allowedRoute = null;
    let routeStopMarkers = []; // Lưu trữ các marker điểm dừng
    let areMarkersVisible = false; // Trạng thái hiển thị marker

    // Icon cho marker
    const locationIcon = L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34]
    });

    const stopIcon = L.icon({
      iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34]
    });
    
    // Icon cho xe buýt (màu đỏ) và điểm dừng trên lộ trình
    const busIcon = L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/1068/1068631.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34]
    });
    
    const busStopIcon = L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png', // Màu xanh cho bến xe
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34]
    });

    const busStopIconActive = L.icon({
      iconUrl:  'https://cdn-icons-png.flaticon.com/512/1068/1068631.png', // Màu đỏ khi trùng với API
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34]
    });

    // Hàm hiển thị lỗi
    function showError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.textContent = message;
      document.querySelector('.sidebar-content').prepend(errorDiv);
      setTimeout(() => errorDiv.remove(), 5000);
    }

    // Hàm tính khoảng cách Haversine (km)
    function haversineDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // Hàm giảm số lượng waypoints để tránh định tuyến không cần thiết
    function simplifyWaypoints(points, maxWaypoints = 5) { // Giảm xuống 5 để cải thiện định tuyến
      if (points.length <= maxWaypoints) return points;
      const step = Math.floor(points.length / (maxWaypoints - 1));
      const simplified = [];
      for (let i = 0; i < points.length; i += step) {
        simplified.push(points[i]);
      }
      // Đảm bảo điểm cuối được thêm vào
      if (simplified[simplified.length - 1] !== points[points.length - 1]) {
        simplified.push(points[points.length - 1]);
      }
      return simplified;
    }

    // Hàm tính khoảng cách từ 1 điểm tới 1 đoạn thẳng (đơn vị: km)
    function pointToSegmentDistance(px, py, x1, y1, x2, y2) {
      const A = px - x1;
      const B = py - y1;
      const C = x2 - x1;
      const D = y2 - y1;

      const dot = A * C + B * D;
      const len_sq = C * C + D * D;
      let param = -1;
      if (len_sq !== 0) param = dot / len_sq;

      let xx, yy;
      if (param < 0) {
        xx = x1;
        yy = y1;
      } else if (param > 1) {
        xx = x2;
        yy = y2;
      } else {
        xx = x1 + param * C;
        yy = y1 + param * D;
      }

      const dx = px - xx;
      const dy = py - yy;
      return Math.sqrt(dx * dx + dy * dy) * 111.32; // Chuyển từ độ sang km
    }
    
    // Tải dữ liệu vị trí từ API và xác định tuyến phù hợp
    async function loadLocations() {
      try {
        const response = await fetch('https://busmapmini.onrender.com/api/buses');
        if (!response.ok) throw new Error(`Lỗi: ${response.status}`);
        const data = await response.json();
    
        // Xóa marker cũ của xe buýt
        Object.values(markers).forEach(marker => map.removeLayer(marker));
        Object.keys(markers).forEach(id => delete markers[id]);
    
        allowedRoute = null;
    
        // Đặt tất cả marker bến xe về màu xanh mặc định trước khi kiểm tra
        routeStopMarkers.forEach(stopMarker => {
          stopMarker.marker.setIcon(busStopIcon);
        });
    
        Object.entries(data).forEach(([busId, location]) => {
          if (typeof location.lat !== 'number' || typeof location.lng !== 'number') return;
    
          const label = `Xe buýt ${busId}`;
          const timestamp = new Date(location.timestamp).toLocaleString();
    
          // Xác định tuyến gần nhất dựa trên khoảng cách Haversine (bán kính 5km)
          for (const [routeId, route] of Object.entries(routesData)) {
            for (const point of route) {
              const distance = haversineDistance(location.lat, location.lng, point[0], point[1]);
              if (distance < 5) { // Trong bán kính 5km
                allowedRoute = routeId;
                break;
              }
            }
            if (allowedRoute) break;
          }
    
          if (allowedRoute) {
            const loc = {
              id: `bus_${busId}`,
              label: label,
              lat: location.lat,
              lng: location.lng,
              timestamp: timestamp
            };
            // Vẽ marker cho xe buýt (màu đỏ)
            markers[loc.id] = L.marker([loc.lat, loc.lng], { icon: busIcon })
              .addTo(map)
              .bindPopup(`<b>${loc.label}</b><br>Vị trí: ${loc.lat.toFixed(5)}, ${loc.lng.toFixed(5)}<br>Thời gian: ${loc.timestamp}`);
    
            // Kiểm tra xem vị trí xe buýt có trùng với bến nào không
            routeStopMarkers.forEach(stopMarker => {
              const stopLat = stopMarker.lat;
              const stopLng = stopMarker.lng;
              const distance = haversineDistance(location.lat, location.lng, stopLat, stopLng);
              if (distance < 0.01) { // Ngưỡng 10m
                stopMarker.marker.setIcon(busStopIconActive); // Đặt màu đỏ cho bến
              }
            });
          }
        });
    
        updateRouteSelect();
      } catch (error) {
        console.error('Lỗi tải vị trí:', error);
        showError('Không thể tải dữ liệu: ' + error.message);
      }
    }

    // Vẽ lộ trình cho tuyến được phép
    function drawRouteForAllowedRoute() {
      if (!allowedRoute) {
        showError('Không có tuyến xe buýt nào được phép hiển thị!');
        return;
      }
    
      const route = routesData[allowedRoute];
      if (!route || route.length === 0) {
        showError('Không có dữ liệu lộ trình cho tuyến ' + allowedRoute);
        return;
      }
    
      if (currentRouteControl) {
        map.removeControl(currentRouteControl);
        currentRouteControl = null;
      }
    
      const waypoints = simplifyWaypoints(route.map(point => L.latLng(point[0], point[1])));
      currentRouteControl = L.Routing.control({
        waypoints: waypoints,
        lineOptions: { styles: [{ color: '#ff0000', weight: 6, opacity: 0.9 }] },
        router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }),
        show: false,
        addWaypoints: false,
        fitSelectedRoutes: true
      }).on('routingerror', (err) => {
        showError('Lỗi định tuyến: ' + (err.error.message || 'Không thể tính toán lộ trình!'));
      }).addTo(map);
    
      // Hiển thị các điểm dừng (marker)
      clearRouteStopMarkers();
      route.forEach((point, index) => {
        const marker = L.marker([point[0], point[1]], { icon: busStopIcon })
          .addTo(map)
          .bindPopup(`Trạm ${index + 1}`);
        routeStopMarkers.push({
          marker: marker,
          lat: point[0],
          lng: point[1]
        });
      });
    
      map.fitBounds(new L.LatLngBounds(waypoints));
    }

    // Cập nhật dropdown tuyến
    function updateRouteSelect() {
      const routeSelect = document.getElementById('routeSelect');
      routeSelect.innerHTML = '<option value="">-- Chọn tuyến --</option>';
      
      if (allowedRoute) {
        const option = document.createElement('option');
        option.value = allowedRoute;
        option.textContent = allowedRoute;
        routeSelect.appendChild(option);
        routeSelect.value = allowedRoute;
      }
    }

    // Di chuyển bản đồ về vị trí hiện tại
    function centerMap() {
      if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
        showError('Vui lòng truy cập qua HTTPS để sử dụng định vị!');
        map.setView(mapCenter, 13);
        return;
      }

      if (!navigator.geolocation) {
        showError('Trình duyệt không hỗ trợ định vị!');
        map.setView(mapCenter, 13);
        return;
      }

      showError('Đang lấy vị trí hiện tại...');

      navigator.geolocation.getCurrentPosition(
        (position) => {
          currentPosition = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };

          const loadingMessage = document.querySelector('.error-message');
          if (loadingMessage && loadingMessage.textContent.includes('Đang lấy vị trí')) {
            loadingMessage.remove();
          }

          map.setView([currentPosition.lat, currentPosition.lng], 15);

          if (currentPositionMarker) {
            map.removeLayer(currentPositionMarker);
          }

          currentPositionMarker = L.marker([currentPosition.lat, currentPosition.lng], { icon: locationIcon })
            .addTo(map)
            .bindPopup(`<b>Vị trí hiện tại</b><br>Vị trí: ${currentPosition.lat.toFixed(5)}, ${currentPosition.lng.toFixed(5)}`)
            .openPopup();

          showError('Đã xác định vị trí hiện tại!');
        },
        (error) => {
          console.error('Lỗi lấy vị trí:', error);
          let errorMessage = 'Không thể lấy vị trí hiện tại: ';
          switch (error.code) {
            case error.PERMISSION_DENIED:
              errorMessage += 'Vui lòng cấp quyền truy cập vị trí trong trình duyệt.';
              break;
            case error.POSITION_UNAVAILABLE:
              errorMessage += 'Không thể xác định vị trí. Vui lòng kiểm tra tín hiệu GPS.';
              break;
            case error.TIMEOUT:
              errorMessage += 'Yêu cầu vị trí hết thời gian. Vui lòng thử lại.';
              break;
            default:
              errorMessage += error.message;
          }
          showError(errorMessage);
          map.setView(mapCenter, 13);
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
    }

    // Tải dữ liệu lộ trình
    let routesData = {};
    const routeColors = { 'BUS08': '#ff0000', 'BUS141': '#0000ff' };

    async function loadRoutes() {
      try {
        const response = await fetch('/routes.json');
        if (!response.ok) throw new Error(`Lỗi: ${response.status}`);
        routesData = await response.json();
      } catch (error) {
        console.error('Lỗi tải lộ trình:', error);
        showError('Không thể tải dữ liệu lộ trình: ' + error.message);
      }
    }

    // Xóa tất cả các marker điểm dừng
    function clearRouteStopMarkers() {
      routeStopMarkers.forEach(stopMarker => map.removeLayer(stopMarker.marker));
      routeStopMarkers = [];
      areMarkersVisible = false;
      document.getElementById('showAllMarkersBtn').textContent = 'Hiển thị tất cả điểm dừng';
    }

    // Hàm hiển thị tất cả điểm dừng trong lộ trình
    function displayAllRouteStops(route, routeId) {
      route.forEach((point, index) => {
        const marker = L.marker([point[0], point[1]], { icon: busStopIcon })
          .addTo(map)
          .bindPopup(`<b>Điểm dừng ${index + 1}</b><br>Tuyến: ${routeId}<br>Vị trí: ${point[0].toFixed(5)}, ${point[1].toFixed(5)}`);
        routeStopMarkers.push({
          marker: marker,
          lat: point[0],
          lng: point[1]
        });
      });
      areMarkersVisible = true;
      document.getElementById('showAllMarkersBtn').textContent = 'Ẩn tất cả điểm dừng';
    }

    // Hàm chuyển đổi hiển thị điểm dừng
    function toggleRouteStopMarkers() {
      const routeId = document.getElementById('routeSelect').value;
      if (!routeId) {
        showError('Vui lòng chọn tuyến xe buýt!');
        return;
      }

      const route = routesData[routeId];
      if (!route || route.length === 0) {
        showError('Không có dữ liệu lộ trình cho tuyến ' + routeId);
        return;
      }

      if (areMarkersVisible) {
        clearRouteStopMarkers();
      } else {
        displayAllRouteStops(route, routeId);
      }
    }

    // Hiển thị lộ trình
    let currentMarkers = [];
    
    function showRoute() {
      const routeId = document.getElementById('routeSelect').value;
      if (!routeId) {
        showError('Vui lòng chọn tuyến xe buýt!');
        return;
      }
    
      if (currentRouteControl) {
        map.removeControl(currentRouteControl);
        currentRouteControl = null;
      }
    
      currentMarkers.forEach(marker => map.removeLayer(marker));
      currentMarkers = [];
    
      const route = routesData[routeId];
      if (route && route.length > 0) {
        const waypoints = simplifyWaypoints(route.map(point => L.latLng(point[0], point[1])));
        const routeColor = routeColors[routeId] || '#000000';
    
        currentRouteControl = L.Routing.control({
          waypoints: waypoints,
          lineOptions: { styles: [{ color: routeColor, weight: 4, opacity: 0.7 }] },
          router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }),
          show: false,
          addWaypoints: false,
          fitSelectedRoutes: true
        }).on('routingerror', (err) => {
          showError('Lỗi định tuyến: ' + (err.error.message || 'Không thể tính toán lộ trình!'));
        }).addTo(map);
    
        route.forEach((point, index) => {
          const marker = L.marker([point[0], point[1]], { icon: busStopIcon })
            .addTo(map)
            .bindPopup(`Trạm ${index + 1}`);
          currentMarkers.push(marker);
          routeStopMarkers.push({
            marker: marker,
            lat: point[0],
            lng: point[1]
          });
        });
    
        map.fitBounds(new L.LatLngBounds(waypoints));
      } else {
        showError('Không có dữ liệu lộ trình cho tuyến ' + routeId);
      }
    }

    // Tìm bến xe gần nhất cho tuyến
    function findNearestStopForRoute(routeId) {
      if (!routeId) {
        showError('Vui lòng chọn tuyến xe buýt!');
        return;
      }

      if (routeId !== allowedRoute) {
        showError('Tuyến xe không hợp lệ cho vị trí hiện tại!');
        return;
      }

      if (!navigator.geolocation) {
        showError('Trình duyệt không hỗ trợ định vị!');
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (position) => {
          currentPosition = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };

          const route = routesData[routeId];
          if (!route || route.length === 0) {
            showError('Không có dữ liệu lộ trình cho tuyến ' + routeId);
            return;
          }

          let nearestStop = null;
          let minDistance = Infinity;
          let nearestIndex = -1;

          route.forEach((point, index) => {
            const distance = haversineDistance(currentPosition.lat, currentPosition.lng, point[0], point[1]);
            if (distance < minDistance) {
              minDistance = distance;
              nearestStop = { lat: point[0], lng: point[1] };
              nearestIndex = index;
            }
          });

          if (!nearestStop) {
            showError('Không tìm thấy bến xe phù hợp!');
            return;
          }

          const nearestStopInfo = document.getElementById('nearestStopInfo');
          nearestStopInfo.innerHTML = `
            <div><strong>Bến xe gần nhất:</strong> Bến ${nearestIndex + 1} (Tuyến ${routeId})</div>
            <div><strong>Vị trí:</strong> ${nearestStop.lat.toFixed(5)}, ${nearestStop.lng.toFixed(5)}</div>
            <div><strong>Khoảng cách:</strong> ${minDistance.toFixed(2)} km</div>
            <button id="showRouteToStopBtn" class="center-btn">Hiển thị đường đi</button>
          `;

          if (nearestStopMarker) map.removeLayer(nearestStopMarker);
          nearestStopMarker = L.marker([nearestStop.lat, nearestStop.lng], { icon: stopIcon })
            .addTo(map)
            .bindPopup(`<b>Bến ${nearestIndex + 1}</b><br>Vị trí: ${nearestStop.lat.toFixed(5)}, ${nearestStop.lng.toFixed(5)}<br>Khoảng cách: ${minDistance.toFixed(2)} km`)
            .openPopup();

          map.setView([nearestStop.lat, nearestStop.lng], 15);

          document.getElementById('showRouteToStopBtn').addEventListener('click', () => {
            showRouteToNearestStop(currentPosition, nearestStop);
          });
        },
        (error) => {
          console.error('Lỗi lấy vị trí:', error);
          showError('Không thể lấy vị trí hiện tại: ' + error.message);
        }
      );
    }

    // Vẽ đường đi đến bến xe gần nhất
    function showRouteToNearestStop(start, end) {
      if (routeToNearestStopControl) {
        map.removeControl(routeToNearestStopControl);
        routeToNearestStopControl = null;
      }

      routeToNearestStopControl = L.Routing.control({
        waypoints: [L.latLng(start.lat, start.lng), L.latLng(end.lat, end.lng)],
        lineOptions: { styles: [{ color: '#28a745', weight: 4, dashArray: '5, 10' }] },
        router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }),
        show: false,
        addWaypoints: false,
        fitSelectedRoutes: true
      }).on('routingerror', (err) => {
        showError('Lỗi định tuyến: ' + (err.error.message || 'Không thể tính toán đường đi đến bến xe!'));
      }).addTo(map);
    }

    // Tìm bến xe gần nhất
    function findNearestStop() {
      const routeId = document.getElementById('routeSelect').value;
      if (!routeId) {
        showError('Vui lòng chọn tuyến xe buýt!');
        return;
      }
      findNearestStopForRoute(routeId);
    }

    // Xóa tất cả marker và lộ trình
    function clearAllMarkers() {
      Object.values(markers).forEach(marker => map.removeLayer(marker));
      Object.keys(markers).forEach(id => delete markers[id]);
      clearRouteStopMarkers();
      if (currentPositionMarker) {
        map.removeLayer(currentPositionMarker);
        currentPositionMarker = null;
      }
      if (nearestStopMarker) {
        map.removeLayer(nearestStopMarker);
        nearestStopMarker = null;
      }
      if (currentRouteControl) {
        map.removeControl(currentRouteControl);
        currentRouteControl = null;
      }
      if (routeToNearestStopControl) {
        map.removeControl(routeToNearestStopControl);
        routeToNearestStopControl = null;
      }
    }

    // Menu toggle
    document.querySelector('.menu-toggle').addEventListener('click', () => {
      const sidebar = document.querySelector('.sidebar');
      sidebar.classList.toggle('open');
    });

    // Sự kiện
    document.getElementById('showRouteBtn').addEventListener('click', showRoute);
    document.getElementById('centerMapBtn').addEventListener('click', centerMap);
    document.getElementById('findNearestStopBtn').addEventListener('click', findNearestStop);
    document.getElementById('routeSelect').addEventListener('change', clearRouteStopMarkers);

    // Tải dữ liệu khi khởi động
    window.addEventListener('load', loadLocations);
    window.addEventListener('load', loadRoutes);
    setInterval(loadLocations, 10000);
  </script>
</body>
</html>