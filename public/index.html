<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hiển thị vị trí</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }
    
    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    
    .header {
      background-color: #0066cc;
      color: white;
      padding: 15px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    
    .content {
      display: flex;
      flex: 1;
    }
    
    .sidebar {
      width: 300px;
      padding: 15px;
      background-color: #f5f5f5;
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
      overflow-y: auto;
    }
    
    #map {
      flex: 1;
      height: 100%;
    }
    
    .route-form {
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    button {
      background-color: #0066cc;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
    }
    
    button:hover {
      background-color: #0055aa;
    }
    
    .location-history {
      margin-top: 20px;
    }
    
    .location-item {
      padding: 10px;
      background-color: white;
      border-radius: 4px;
      margin-bottom: 10px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      cursor: pointer;
    }
    
    .location-item:hover {
      background-color: #f0f0f0;
    }
    
    .location-label {
      font-weight: bold;
      color: #0066cc;
    }
    
    .location-info {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
    
    .center-btn {
      margin-top: 10px;
      background-color: #28a745;
    }
    
    .center-btn:hover {
      background-color: #218838;
    }
    
    .delete-btn {
      background-color: #dc3545;
      margin-top: 5px;
      padding: 5px;
      width: auto;
    }
    
    .delete-btn:hover {
      background-color: #c82333;
    }
    
    .error-message {
      color: red;
      padding: 10px;
      margin-bottom: 10px;
      background-color: #ffe6e6;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Hiển thị vị trí</h1>
    </div>
    
    <div class="content">
      <div class="sidebar">
        <div class="route-form">
          <h3>Chọn lộ trình</h3>
          <div class="form-group">
            <label for="routeSelect">Tuyến xe buýt:</label>
            <select id="routeSelect">
              <option value="">-- Chọn tuyến --</option>
            </select>
          </div>
          <button id="showRouteBtn">Hiển thị lộ trình</button>
          <button id="centerMapBtn" class="center-btn">Về trung tâm bản đồ</button>
        </div>
        
        <div class="location-history">
          <h3>Danh sách vị trí</h3>
          <div id="locationList"></div>
        </div>
      </div>
      
      <div id="map"></div>
    </div>
  </div>
  
  <script>
    // Khởi tạo bản đồ
    const map = L.map('map').setView([21.027763, 105.83416], 13); // Trung tâm mặc định
    const mapCenter = [21.027763, 105.83416];

    // Thêm layer bản đồ OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Lưu trữ dữ liệu vị trí
    const locations = [];
    const markers = {};

    // Icon cho marker vị trí
    const locationIcon = L.icon({
      iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34]
    });

    // Hàm hiển thị thông báo lỗi
    function showError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.textContent = message;
      document.querySelector('.sidebar').prepend(errorDiv);
      setTimeout(() => errorDiv.remove(), 3000);
    }

    // Hàm tải dữ liệu vị trí từ API busmapmini
    async function loadLocations() {
      try {
        console.log('Đang gọi API https://busmapmini.onrender.com/api/buses...');
        const response = await fetch('https://busmapmini.onrender.com/api/buses');
        if (!response.ok) {
          throw new Error(`Lỗi khi lấy dữ liệu: ${response.status} - ${response.statusText}`);
        }
        const data = await response.json();
        console.log('Dữ liệu nhận được từ API:', data);
    
        // Xóa tất cả marker hiện tại
        Object.values(markers).forEach(marker => map.removeLayer(marker));
        locations.length = 0;
        Object.keys(markers).forEach(id => delete markers[id]);
    
        // Chuyển object thành mảng và thêm các vị trí từ API
        Object.entries(data).forEach(([busId, location], index) => {
          // Kiểm tra dữ liệu hợp lệ
          if (typeof location.lat !== 'number' || typeof location.lng !== 'number') {
            console.warn('Dữ liệu không hợp lệ, bỏ qua:', busId, location);
            return;
          }
    
          // Tạo nhãn từ busId (c1, c2,...)
          const label = `Xe buýt ${busId}`;
          const timestamp = new Date(location.timestamp).toLocaleString();
    
          const loc = {
            id: `bus_${busId}`,
            label: label,
            lat: location.lat,
            lng: location.lng,
            timestamp: timestamp
          };
    
          locations.push(loc);
          markers[loc.id] = L.marker([loc.lat, loc.lng], { icon: locationIcon })
            .addTo(map)
            .bindPopup(`<b>${loc.label}</b><br>Vị trí: ${loc.lat.toFixed(5)}, ${loc.lng.toFixed(5)}<br>Thời gian: ${loc.timestamp}`);
        });
    
        updateLocationList();
      } catch (error) {
        console.error('Lỗi khi tải dữ liệu:', error);
        showError('Không thể tải danh sách vị trí: ' + error.message);
      }
    }

    // Hàm cập nhật danh sách vị trí
    function updateLocationList() {
      const locationListElement = document.getElementById('locationList');
      locationListElement.innerHTML = '';

      if (locations.length === 0) {
        locationListElement.innerHTML = '<p>Chưa có vị trí nào được thêm.</p>';
        return;
      }

      locations.slice().reverse().forEach(location => {
        const locationItem = document.createElement('div');
        locationItem.className = 'location-item';
        locationItem.innerHTML = `
          <div class="location-label">${location.label}</div>
          <div class="location-info">
            Vị trí: ${location.lat.toFixed(5)}, ${location.lng.toFixed(5)}<br>
            Thời gian: ${location.timestamp}
          </div>
        `;

        locationItem.addEventListener('click', (e) => {
          map.setView([location.lat, location.lng], 15);
          markers[location.id].openPopup();
        });

        locationListElement.appendChild(locationItem);
      });
    }

    // Hàm di chuyển bản đồ về trung tâm
    function centerMap() {
      map.setView(mapCenter, 13);
    }

    // Lưu trữ dữ liệu lộ trình
    let routesData = {};
    const polylines = {};

    // Màu sắc cho các tuyến
    const routeColors = {
      'BUS08': '#ff0000', // Đỏ
      'BUS141': '#0000ff', // Xanh dương
    };

    // Tải dữ liệu lộ trình từ routes.json
    async function loadRoutes() {
      try {
        console.log('Đang tải dữ liệu lộ trình từ routes.json...');
        const response = await fetch('/routes.json'); // Đảm bảo routes.json nằm trong thư mục public
        if (!response.ok) {
          throw new Error(`Lỗi khi tải routes.json: ${response.status} - ${response.statusText}`);
        }
        routesData = await response.json();
        console.log('Dữ liệu lộ trình:', routesData);

        // Điền danh sách tuyến vào dropdown
        const routeSelect = document.getElementById('routeSelect');
        Object.keys(routesData).forEach(routeId => {
          const option = document.createElement('option');
          option.value = routeId;
          option.textContent = routeId;
          routeSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Lỗi khi tải dữ liệu lộ trình:', error);
        showError('Không thể tải dữ liệu lộ trình: ' + error.message);
      }
    }

    // Hàm hiển thị lộ trình
    function showRoute() {
      const routeId = document.getElementById('routeSelect').value;
      if (!routeId) {
        showError('Vui lòng chọn một tuyến xe buýt!');
        return;
      }

      // Xóa các polyline cũ
      Object.values(polylines).forEach(polyline => map.removeLayer(polyline));
      Object.keys(polylines).forEach(id => delete polylines[id]);

      // Vẽ lộ trình mới
      const route = routesData[routeId];
      if (route && route.length > 0) {
        const routeColor = routeColors[routeId] || '#000000'; // Màu mặc định nếu không có trong routeColors
        const polyline = L.polyline(route, { color: routeColor, weight: 4 }).addTo(map);
        polylines[routeId] = polyline;

        // Điều chỉnh bản đồ để hiển thị toàn bộ lộ trình
        map.fitBounds(polyline.getBounds());
      } else {
        showError('Không có dữ liệu lộ trình cho tuyến ' + routeId);
      }
    }

    // Xử lý sự kiện
    document.getElementById('showRouteBtn').addEventListener('click', showRoute);
    document.getElementById('centerMapBtn').addEventListener('click', centerMap);

    // Tải dữ liệu khi trang load
    window.addEventListener('load', loadLocations);
    window.addEventListener('load', loadRoutes);

    // Tự động cập nhật dữ liệu mỗi 10 giây
    setInterval(loadLocations, 10000);
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9300141638c5454c',t:'MTc0NDYwMDk0My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>